# UGTF CI/CD Pipeline for Django on Google Cloud Run
name: Django CI/CD to Cloud Run (ugtf_site)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

env:
  PROJECT_ID: top-cedar-471512-k3
  PROJECT_NUMBER: 30228073381
  REGION: us-east1
  SERVICE_NAME: ugtfsite
  SERVICE_URL: https://ugtfsite-30228073381.us-east1.run.app

jobs:
  # 1Ô∏è‚É£ Build and Deploy
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          workload_identity_provider: projects/${{ env.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/ugtf-github-pool/providers/github-actions
          service_account: github-runner-ugtf@${{ env.PROJECT_ID }}.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Build and Push Docker Image
        id: build
        run: |
          IMAGE_TAG="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          echo "Building image: $IMAGE_TAG"
          docker build -t "$IMAGE_TAG" .
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet
          docker push "$IMAGE_TAG"
          echo "image=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{ steps.build.outputs.image }}
          wait: true

  # 2Ô∏è‚É£ Health Check
  health-check:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    steps:
      - name: Verify Cloud Run deployment health
        run: |
          echo "Checking service health at ${{ env.SERVICE_URL }}..."
          for i in {1..10}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.SERVICE_URL }})
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ Health check passed (HTTP 200)"
              exit 0
            fi
            echo "Waiting for service... (status $STATUS)"
            sleep 5
          done
          echo "‚ùå Service did not become healthy in time."
          exit 1

  # 3Ô∏è‚É£ Lighthouse Audit (Desktop + Mobile)
  lighthouse-audit:
    needs: health-check
    runs-on: ubuntu-latest
    outputs:
      lighthouse_summary: ${{ steps.summary.outputs.lighthouse_summary }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Lighthouse CI
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          npm install -g @lhci/cli@0.13.x

      - name: Run Lighthouse Audit (Desktop + Mobile)
        run: |
          mkdir -p .lighthouseci
          echo "üèÅ Running Lighthouse (Desktop)..."
          lhci collect \
            --url=${{ env.SERVICE_URL }} \
            --numberOfRuns=1 \
            --settings.formFactor=desktop \
            --settings.screenEmulation.mobile=false \
            --settings.throttlingMethod=provided || true

          DESKTOP_REPORT=$(find .lighthouseci -name "lhr-*.json" | sort | tail -n 1)
          cp "$DESKTOP_REPORT" .lighthouseci/lighthouse-desktop.json

          echo "üì± Running Lighthouse (Mobile)..."
          lhci collect \
            --url=${{ env.SERVICE_URL }} \
            --numberOfRuns=1 \
            --settings.formFactor=mobile \
            --settings.throttlingMethod=simulate || true

          MOBILE_REPORT=$(find .lighthouseci -name "lhr-*.json" | sort | tail -n 1)
          cp "$MOBILE_REPORT" .lighthouseci/lighthouse-mobile.json

      - name: Extract Lighthouse Scores (Desktop + Mobile)
        id: summary
        run: |
          echo "Extracting metrics from Lighthouse reports..."
          DESKTOP_REPORT=$(find .lighthouseci -name "lighthouse-desktop.json")
          MOBILE_REPORT=$(find .lighthouseci -name "lighthouse-mobile.json")

          if [ -z "$DESKTOP_REPORT" ] || [ -z "$MOBILE_REPORT" ]; then
            echo "‚ùå Missing one or both Lighthouse reports!"
            exit 1
          fi

          DESKTOP_PERF=$(jq '.categories.performance.score' $DESKTOP_REPORT)
          DESKTOP_ACC=$(jq '.categories.accessibility.score' $DESKTOP_REPORT)
          DESKTOP_BP=$(jq '.categories["best-practices"].score' $DESKTOP_REPORT)
          DESKTOP_SEO=$(jq '.categories.seo.score' $DESKTOP_REPORT)
          DESKTOP_LCP=$(jq '.audits["largest-contentful-paint"].numericValue' $DESKTOP_REPORT)
          DESKTOP_CLS=$(jq '.audits["cumulative-layout-shift"].numericValue' $DESKTOP_REPORT)
          DESKTOP_TBT=$(jq '.audits["total-blocking-time"].numericValue' $DESKTOP_REPORT)

          MOBILE_PERF=$(jq '.categories.performance.score' $MOBILE_REPORT)
          MOBILE_ACC=$(jq '.categories.accessibility.score' $MOBILE_REPORT)
          MOBILE_BP=$(jq '.categories["best-practices"].score' $MOBILE_REPORT)
          MOBILE_SEO=$(jq '.categories.seo.score' $MOBILE_REPORT)
          MOBILE_LCP=$(jq '.audits["largest-contentful-paint"].numericValue' $MOBILE_REPORT)
          MOBILE_CLS=$(jq '.audits["cumulative-layout-shift"].numericValue' $MOBILE_REPORT)
          MOBILE_TBT=$(jq '.audits["total-blocking-time"].numericValue' $MOBILE_REPORT)

          SUMMARY="Lighthouse Results:
          üñ•Ô∏è Desktop: Performance=$DESKTOP_PERF, Accessibility=$DESKTOP_ACC, BestPractices=$DESKTOP_BP, SEO=$DESKTOP_SEO, LCP=${DESKTOP_LCP}ms, CLS=${DESKTOP_CLS}, TBT=${DESKTOP_TBT}ms
          üì± Mobile: Performance=$MOBILE_PERF, Accessibility=$MOBILE_ACC, BestPractices=$MOBILE_BP, SEO=$MOBILE_SEO, LCP=${MOBILE_LCP}ms, CLS=${MOBILE_CLS}, TBT=${MOBILE_TBT}ms"

          SUMMARY_ESCAPED=$(echo "$SUMMARY" | tr '\n' ' ' | tr -d '\r')
          echo "lighthouse_summary=$SUMMARY_ESCAPED" >> $GITHUB_OUTPUT

  # 4Ô∏è‚É£ Python SEO Audit
  seo-audit:
    needs: lighthouse-audit
    runs-on: ubuntu-latest
    outputs:
      issues_summary: ${{ steps.summary.outputs.issues_summary }}
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml jq

      - name: Run SEO Audit
        run: |
          python - <<'EOF'
          import requests, json
          from bs4 import BeautifulSoup
          from urllib.parse import urljoin

          url = "${{ env.SERVICE_URL }}"
          print(f"üîç Auditing {url} for SEO issues...")
          resp = requests.get(url, timeout=10)
          soup = BeautifulSoup(resp.text, "lxml")

          issues = []
          if not soup.title or not soup.title.string.strip():
              issues.append("Missing <title>")
          if not soup.find("meta", attrs={"name": "description"}):
              issues.append("Missing meta description")
          if not soup.find("h1"):
              issues.append("Missing <h1> tag")

          broken_links = []
          for a in soup.find_all("a", href=True):
              link = urljoin(url, a["href"])
              if link.startswith(("tel:", "mailto:")):
                  continue
              try:
                  r = requests.head(link, allow_redirects=True, timeout=5)
                  if r.status_code >= 400:
                      broken_links.append(link)
              except Exception:
                  broken_links.append(link)
          if broken_links:
              issues.append(f"{len(broken_links)} broken links found")

          report = {"url": url, "issues": issues, "broken_links": broken_links, "total_issues": len(issues)}
          with open("seo-results.json", "w") as f:
              json.dump(report, f, indent=2)
          print(f"‚úÖ SEO audit complete: {len(issues)} issues found.")
          EOF

      - name: Generate SEO Summary
        id: summary
        run: |
          SUMMARY=$(jq -r '.issues[:3] | join(", ")' seo-results.json)
          echo "issues_summary=$SUMMARY" >> $GITHUB_OUTPUT

  # 5Ô∏è‚É£ Notify via Email
  notify:
    needs: [lighthouse-audit, seo-audit]
    runs-on: ubuntu-latest
    steps:
      - name: Send Email Summary
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "üöÄ UGTF CI/CD Report: ${{ env.SERVICE_NAME }} Deployment Results"
          to: ono@ugtf.org
          from: UGTF CI Bot
          body: |
            ‚úÖ Deployment completed for *${{ env.SERVICE_NAME }}*

            üåç URL: ${{ env.SERVICE_URL }}

            **üìä Lighthouse Summary**
            ${{ needs.lighthouse-audit.outputs.lighthouse_summary }}

            **üß© SEO Summary**
            ${{ needs.seo-audit.outputs.issues_summary }}